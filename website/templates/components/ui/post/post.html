{# templates/components/ui/post.html #}

{% macro render_post(post) %}
<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
  <div class="flex items-center justify-between px-4 py-2">
    <div class="flex items-center">
      <div
        x-data="{ loaded: false, bg: '{{ post.author.avatar_url if post.author.avatar_url else url_for('static', filename='images/no-avatar.jpg') }}' }"
        :style="{
        backgroundImage: loaded ? 'none' : 'url(' + bg + ')',
        backgroundColor: loaded ? 'transparent' : '#DBDBDB'
      }"
        class="relative h-9 w-9 rounded-full overflow-hidden bg-cover bg-center mr-3"
        aria-label="profile picture"
        role="img"
      >
        {% if post.author.avatar_url %}
        <img
          @load="loaded = true"
          class="absolute inset-0 h-full w-full object-cover"
          loading="lazy"
          src="{{ post.author.avatar_url }}"
        />
        {% endif %}
      </div>
      <span class="text-sm font-semibold text-gray-900 dark:text-gray-100">
      {{ post.author.username }}
    </span>
    </div>

    {% if is_admin %}
    <div x-data="{ open: false }" class="relative flex">
      <button
        type="button"
        @click="open = !open"
        class="flex items-center justify-center rounded-full dark:bg-gray-800 p-1 focus:outline-none"
        aria-label="More options"
      >
        <svg
          aria-label="More options"
          class="w-6 h-6 text-gray-800 dark:text-white"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <title>More options</title>
          <circle cx="12" cy="12" r="1.5"></circle>
          <circle cx="6" cy="12" r="1.5"></circle>
          <circle cx="18" cy="12" r="1.5"></circle>
        </svg>
      </button>

      <div
        x-show="open"
        x-cloak
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 scale-95"
        x-transition:enter-end="opacity-100 scale-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100 scale-100"
        x-transition:leave-end="opacity-0 scale-95"
        @click.outside="open = false"
        class="overflow-hidden absolute right-0 z-50 mt-8 w-44 origin-top-right rounded-md bg-gray-800 focus:outline-none dark:bg-white"
        style="display: none"
      >
        <a
          href="/posts/edit/{{ post.id }}?token={{ token }}"
          class="block px-4 py-2 text-sm text-white hover:bg-gray-700 dark:text-gray-700 dark:hover:bg-gray-100"
          role="menuitem"
        >
          Edit Post
        </a>
        <form method="POST" action="/posts/{{ post.id }}/delete" class="w-full">
          <button
            type="submit"
            class="block w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-gray-700 dark:text-red-700 dark:hover:bg-gray-100"
          >
            Remove Post
          </button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
  {% if post.images and post.images|length > 0 %}
  <div
    x-data
    x-init="
      new Swiper($el, {
        loop: true,
        slidesPerView: 1,
        spaceBetween: 0,
        pagination: { el: $el.querySelector('.swiper-pagination'), clickable: true },
        navigation: {
          nextEl: $el.querySelector('.swiper-button-next'),
          prevEl: $el.querySelector('.swiper-button-prev')
        }
      })
    "
    class="swiper-container relative"
  >
    <div class="swiper-wrapper">
      {% for image in post.images %}
      <div class="swiper-slide">
        <img
          class="w-full h-[275px] [@media(min-width:475px)]:h-[325px] object-cover"
          src="{{ image.image_url }}"
        />
      </div>
      {% endfor %}
    </div>
    {% if post.images|length > 1 %}
    <div class="swiper-pagination"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
    {% endif %}
  </div>

  <div
    x-data="{
      shareLink: '',
      toastOpen: false,
      copy() {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(this.shareLink);
        } else {
          const ta = document.createElement('textarea');
          ta.value = this.shareLink;
          ta.setAttribute('readonly', '');
          ta.style.position = 'absolute';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
        this.toastOpen = true;
        setTimeout(() => this.toastOpen = false, 2000);
      }
    }"
    x-init="shareLink = window.location.origin + '/posts/{{ post.id }}'"
    class="px-4 py-2 flex justify-between items-center border-b border-gray-200 dark:border-gray-700 relative"
  >
    <div class="flex space-x-4">
      <button type="button" class="focus:outline-none" aria-label="Copy link" @click="copy()">
        <svg class="text-gray-900 dark:text-gray-100 w-[22px]" fill="currentColor" width="24" height="24" viewBox="0 0 24 24">
          <title>Copy link</title>
          <path d="m9.726 5.123 1.228-1.228a6.47 6.47 0 0 1 9.15 9.152l-1.227 1.227m-4.603 4.603-1.228 1.228a6.47 6.47 0 0 1-9.15-9.152l1.227-1.227" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
          <line x1="8.471" y1="15.529" x2="15.529" y2="8.471" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
        </svg>
      </button>
    </div>

    {% if current_user.is_authenticated %}
    <div
      x-data="{
        saved: {{ post.saved_by|selectattr('user_id','equalto', current_user.id)|list and 'true' or 'false' }},
        toggle() {
          fetch('{{ url_for('posts.toggle_save', post_id=post.id) }}', {
            method: 'POST',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          })
          .then(r => r.json())
          .then(data => this.saved = data.saved);
        }
      }"
      class="flex items-center"
    >
      <button
        type="button"
        @click.prevent="toggle()"
        :aria-label="saved ? 'Unsave' : 'Save'"
        class="focus:outline-none"
      >
        <svg
          class="w-[22px] transition-colors duration-150 text-gray-900 dark:text-gray-100"
          fill="none"
          width="24"
          height="24"
          viewBox="0 0 24 24"
        >
          <title x-text="saved ? 'Unsave' : 'Save'"></title>
          <polygon
            :fill="saved ? 'currentColor' : 'none'"
            points="20 21 12 13.44 4 21 4 3 20 3 20 21"
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
          />
        </svg>
      </button>
    </div>
    {% endif %}

    <template x-if="toastOpen">
      <div class="fixed inset-x-0 bottom-0 z-50 flex justify-center items-end pointer-events-none">
        <div class="pointer-events-auto w-full bg-gray-700 dark:bg-gray-700 text-white text-sm px-4 py-3 sm:py-2 rounded-t-lg shadow-lg">
          Link copied to clipboard.
        </div>
      </div>
    </template>
  </div>
  {% endif %}

  <div class="px-4 pb-4 pt-3">
    {% set words = post.content.split(' ') %}
    {% if words|length > 50 %}
    <div x-data="{ expanded: false }">
      <p class="text-sm text-gray-900 dark:text-gray-300">
        {% set excerpt = words[:50]|join(' ') %} {{ excerpt }}
        <span x-show="!expanded">
          <button
            @click="expanded = true"
            class="inline text-blue-600 dark:text-blue-400 text-sm hover:underline"
          >
            more
          </button>
        </span>
        <span x-show="expanded">
          {{ words[50:]|join(' ') }}
        </span>
      </p>
    </div>
    {% else %}
    <p class="text-sm text-gray-700 dark:text-gray-100">{{ post.content }}</p>
    {% endif %}
    <div class="mt-2 flex items-center justify-start">
      <span class="text-gray-500 text-xs">{{ post.created_at.strftime("%b %d, %Y") }}</span>
    </div>
  </div>
</div>
{% endmacro %}
